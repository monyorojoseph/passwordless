<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <title>Passwordless</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
        <script src="https://unpkg.com/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
    </head>
    <body>

        <main>
            <header></header>
            <section class="container my-3 py-5">
                <div class="row justify-content-md-center">
                    <div class="col-md-6">
                        <form id="form">
                            <div>
                                <p id="success" class="text-success"></p>
                                <p id="error" class="text-danger"></p>

                            </div>
                            <div class="mb-2">
                                <label  class="form-label">Username</label>
                                <input type="text" name="username" class="form-control form-control-sm" >
                              </div>
                            <div class="mb-2">
                              <label class="form-label">Email address</label>
                              <input type="email" name="email" class="form-control form-control-sm"  aria-describedby="emailHelp">
                            </div>
                            <button type="submit"  class="btn btn-sm btn-primary">Submit</button>
                          </form>
                    </div>
                </div>
            </section>
        </main>

        <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js" integrity="sha384-ODmDIVzN+pFdexxHEHFBQH3/9/vQ9uori45z4JjnFsRydbmQbmL5t1tQ0culUzyK" crossorigin="anonymous"></script>   
        
        <script>
            const { startRegistration } = SimpleWebAuthnBrowser;

            // <button>
            const elemBegin = document.getElementById('btnBegin');
            // <span>/<p>/etc...
            const elemSuccess = document.getElementById('success');
            // <span>/<p>/etc...
            const elemError = document.getElementById('error');

            const form = document.getElementById('form');

            form.addEventListener('submit', async(event)=> {

                event.preventDefault();
                const data = new FormData(form)
                const n_data = {username:data.get('username'), email:data.get('email')}

                elemSuccess.innerHTML = ''
                elemSuccess.innerHTML = ''
                console.log(n_data)
                console.log('FETCHING')

                const response = await fetch('http://localhost:8000/user/registration', {
                method: 'POST', // *GET, POST, PUT, DELETE, etc.
                mode: 'no-cors', // no-cors, *cors, same-origin
                cache: 'no-cache', // *default, no-cache, reload, force-cache, only-if-cached
                credentials: 'same-origin', // include, *same-origin, omit
                headers: {
                    'Content-Type': 'application/json'
                    // 'Content-Type': 'application/x-www-form-urlencoded',
                },
                redirect: 'follow', // manual, *follow, error
                referrerPolicy: 'no-referrer', // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
                body: JSON.stringify(n_data) // body data type must match "Content-Type" header
                });
                // return response.json(); // parses JSON response into native JavaScript objects

                


                let attResp;

                try{
                    console.log("ASSIGNIN attResp")
                    console.lo(await response.json())
                    attResp = await startRegistration(await response.json());
                } catch(error){
                    console.log(error.name)
                    if(error.name == 'InvalidStateError'){
                        elemError.innerText = 'Error: Authenticator was probably already registered by user';
                    }else{
                        elemError.innerText = error;
                    } 
                    throw error;
                }

                // const verification = await fetch
            })
        </script>
    </body>
</html>